version: "3.9"

services:
  # API Gateway
  api-gateway:
    build: .
    container_name: virtualib_api_gateway
    ports:
      - "8080:80"
    env_file:
      - .env
    environment:
      - SESSION_SAVE_HANDLER=redis
      - SESSION_SAVE_PATH=tcp://redis:6379?database=0&prefix=PHPSESSID
      - SESSION_NAME=PHPSESSID
    volumes:
      - .:/var/www/html
    depends_on:
      - auth-service
      - books-service
      - notifications-service
      - dashboard-service
      - redis

  # Auth Service
  auth-service:
    build: .
    container_name: virtualib_auth_service
    ports:
      - "8081:80"
    env_file:
      - .env
    volumes:
      - .:/var/www/html
    environment:
      - SERVICE_NAME=auth
      - SERVICE_PORT=8081
      - SESSION_SAVE_HANDLER=redis
      - SESSION_SAVE_PATH=tcp://redis:6379?database=0&prefix=PHPSESSID
    depends_on:
      - mysql
      - redis

  # Books Service
  books-service:
    build: .
    container_name: virtualib_books_service
    ports:
      - "8082:80"
    env_file:
      - .env
    volumes:
      - .:/var/www/html
    environment:
      - SERVICE_NAME=books
      - SERVICE_PORT=8082
    depends_on:
      - mysql

  # Notifications Service
  notifications-service:
    build: .
    container_name: virtualib_notifications_service
    ports:
      - "8083:80"
    env_file:
      - .env
    volumes:
      - .:/var/www/html
    environment:
      - SERVICE_NAME=notifications
      - SERVICE_PORT=8083
    depends_on:
      - mysql

  # Dashboard Service
  dashboard-service:
    build: .
    container_name: virtualib_dashboard_service
    ports:
      - "8084:80"
    env_file:
      - .env
    volumes:
      - .:/var/www/html
    environment:
      - SERVICE_NAME=dashboard
      - SERVICE_PORT=8084
    depends_on:
      - mysql


  # Nginx Load Balancer (opcional)
  nginx:
    image: nginx:alpine
    container_name: virtualib_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - api-gateway

  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: virtualib_mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=virtualib
      - MYSQL_USER=virtualib_user
      - MYSQL_PASSWORD=virtualib_pass
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docs/sql:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password

  # Redis para sess√µes PHP compartilhadas
  redis:
    image: redis:6.2-alpine
    container_name: virtualib_redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data

volumes:
  mysql-data:
  redis-data:

